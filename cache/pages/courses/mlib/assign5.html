<div class="section" id="protein-structure-prediction-distance-and-angles">
<h1>Protein Structure Prediction: Distance and Angles</h1>
<div class="section" id="due-april-28th-before-midnight">
<h2>Due: April 28th, before midnight</h2>
<p>In this assignment, you will add a dihedral angle prediction in addtion
to the distance matrix prediction, and you also have to convert the
predicted distance matrix or the dihedral angles into actual 3D coords.</p>
</div>
</div>
<div class="section" id="data">
<h1>Data</h1>
<p>We will again make use of the <a class="reference external" href="https://github.com/aqlaboratory/proteinnet">ProteinNet Dataset</a>. The details of the
ProteinNet data are mentioned at <a class="reference external" href="https://github.com/aqlaboratory/proteinnet/blob/master/docs/proteinnet_records.md">ProteinNet Records</a>.
You can experiment with the smaller CASP7 set.</p>
<p>ProteinNet does not contain the true phi and psi angle pairs that we
need for dihedral angle prediction. You can use the <a class="reference internal" href="#code">Code</a> shown below
to compute the dihedral angles. This will insert the <cite>[PHIPSI]</cite> entries
into the ProteinNet files.</p>
<p>For converting dihedral to 3D coords, you can use the following mean
bond length (in <span class="math">\(A^\circ\)</span>) and bond angle (in radians) values.
These were computed from the <em>training_30</em> ProteinNet file:</p>
<div class="line-block">
<div class="line">bond length C-N 1.3294833825070522</div>
<div class="line">bond length N-Ca 1.458975080720938</div>
<div class="line">bond length Ca-C 1.5247020987105642</div>
<div class="line">bond length C-N-Ca 2.1201622818174655</div>
<div class="line">bond length N-Ca-C 1.9387460083687984</div>
<div class="line">bond length Ca-C-N 2.034323200635229</div>
<div class="line"><br /></div>
</div>
<p>FYI, the following plot also shows the phi (x-axis) vs. psi (y-axis)
scatterplot (called the Ramachandran plot) from the 10333 protein
structures in <em>training_30</em>.</p>
<img alt="phi-psi plot" src="/images/mlib/training_30_phipsi_plot.png" style="width: 500px;" />
</div>
<div class="section" id="method">
<h1>Method</h1>
<p>You will resue the same code from <a href="/courses/mlib/mlib_assign4/">CSCI4969-6969 Assign4 </a></p>
<p>The main difference is that you have to add a new output &quot;head&quot; to
predict the phi and psi angles per position in the crop. You will use
cross-entropy loss to compute the loss from the angle prediction. Use 36
bins to discretize the dihedral angles (so you get <span class="math">\(10^\circ\)</span> or
<span class="math">\(\pi/18\)</span> radians per bin).</p>
<p>The final loss for training from a crop is the sum of the distance
matrix loss and dihedral angle loss.</p>
<p>Once the joint model has been trained, apply it to the test set to
compute the accuracy values for contact prediction as in assign4.</p>
<p>Given a test protein, you should include a command line option
to generate the 3D structure. You must implement at least one of the
following two methods: 1) use distance geometry to predict the 3D coords
from the distance map, oe 2) use NERF method to predict the 3D coords
from the dihedral angles (and the bond lengths and angles noted in
<a class="reference internal" href="#data">Data</a>).</p>
<p>For the distance geometry method, you have to compute the matrix $M$ of
dot products from the distance matrix (as described in class), then
compute its eigenvectors $W$ and values <span class="math">\(\Lambda\)</span>, and the obtain
the 3D coords as <span class="math">\(A = (\Lambda^{1/2} W)^T\)</span></p>
<p>For dihedral angle to 3D coords you can use the pNERF implementation in
<a class="reference external" href="https://github.com/biolib/openprotein">OpenProtein</a></p>
<p>Lastly, you your print out the 3D coords to a file in the PDB format
(see <a class="reference external" href="https://biopython.org/wiki/The_Biopython_Structural_Bioinformatics_FAQ">Bio.PDB</a>),
and visulaize the 3D protein structure using <a class="reference external" href="https://pymolwiki.org/index.php/Main_Page">PyMOL</a>. Include the predicted
structure file as part of your submission.</p>
<div class="section" id="submission">
<h2>Submission</h2>
<p>Submit <strong>assign5.py</strong> via submitty, along with an output file (txt/pdf)
that summarizes the results of your method in terms of training and
testing accuracy values.</p>
<p>Your code must <strong>not</strong> hardcode any filenames or directories, but rather
accept them from the command line input. Your code will be run as:</p>
<div class="line-block">
<div class="line">assign4.py TRAIN TEST NG [PDBID]</div>
<div class="line"><br /></div>
</div>
<p>where TRAIN is the training file (e.g., training_30), and TEST is the
testing file. Here NG is an integer that denotes the nubmer of block
groups to train on. Here PDBID is an optional parameter that specifies a
test protein file in ProteinNet format containing only one protein. If
this parameter is specified it is the protein for which you have to
generate the 3D coords and the visulaize it. <strong>I will specify a specific
protein for structure generation soon.</strong></p>
</div>
<div class="section" id="code">
<h2>Code</h2>
<p>Here is the code to compute phi and psi angles to extend the ProteinNet
files.</p>
<p>Example run: <strong>compute_phi_psi.py training_30</strong></p>
<p>This will generate a new file <strong>training_30_ext</strong> that includes the new
header entry '[PHIPSI]' after the tertirary structure entires, followed
by two new lines. The first line has all the <span class="math">\(\phi_i\)</span> angles and
the second line has all the <span class="math">\(\psi_i\)</span> angles, for $i=1,2, ..., n$.
All angles are in radians and range between <span class="math">\([-\pi, \pi]\)</span>, with a
value of $10$ denoting invalid angle (means it was not possible to
compute it for that position due to missing coordinates in the PDB
file). You should not predict these invalid angles, and they can be
excluded from the loss too.</p>
<p>Note that you will need to install <a class="reference external" href="https://biopython.org/">Biopython</a>
to run the code.</p>
<p><a href="link://listing/listings/mlib/compute_phi_psi.py">mlib/compute_phi_psi.py</a>  <a href="link://listing_source/listings/mlib/compute_phi_psi.py">(Source)</a><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">Bio.PDB.vectors</span> <span class="kn">import</span> <span class="n">Vector</span><span class="p">,</span> <span class="n">calc_angle</span><span class="p">,</span> <span class="n">calc_dihedral</span>

<span class="n">MAX_SEQUENCE_LENGTH</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">AA_ID_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
              <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span>
              <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>

<span class="n">INVALID_ANGLE</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># invalid angle value</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;compute_phi_psi.py&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;fname&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-plot&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">encode_primary_string</span><span class="p">(</span><span class="n">primary</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">([</span><span class="n">AA_ID_DICT</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">primary</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">running_stats</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;this class computes mean and std values for a</span>
<span class="sd">    list of values across proteins&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Vin</span><span class="p">):</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Vin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Vin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="n">mu</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bond length&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">compute_stats</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Compute mean and std values for bond lengths and bond angles&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CN</span> <span class="o">=</span> <span class="n">running_stats</span><span class="p">(</span><span class="s2">&quot;CN&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NCa</span> <span class="o">=</span> <span class="n">running_stats</span><span class="p">(</span><span class="s2">&quot;NCa&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CaC</span> <span class="o">=</span> <span class="n">running_stats</span><span class="p">(</span><span class="s2">&quot;CaC&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CNCa</span> <span class="o">=</span> <span class="n">running_stats</span><span class="p">(</span><span class="s2">&quot;CNCa&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NCaC</span> <span class="o">=</span> <span class="n">running_stats</span><span class="p">(</span><span class="s2">&quot;NCaC&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CaCN</span> <span class="o">=</span> <span class="n">running_stats</span><span class="p">(</span><span class="s2">&quot;CaCN&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v_CN</span><span class="p">,</span> <span class="n">v_NCa</span><span class="p">,</span> <span class="n">v_CaC</span><span class="p">,</span> <span class="n">v_CNCa</span><span class="p">,</span> <span class="n">v_NCaC</span><span class="p">,</span> <span class="n">v_CaCN</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CN</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v_CN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NCa</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v_NCa</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CaC</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v_CaC</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CNCa</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v_CNCa</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NCaC</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v_NCaC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CaCN</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v_CaCN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CN</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NCa</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CaC</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CNCa</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NCaC</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CaCN</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">process_tertiary</span><span class="p">(</span><span class="n">tertiary</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;compute the bond lengths, bond angles, and dihedral angles&#39;&#39;&#39;</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bond_angle_CNCa</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bond_angle_NCaC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bond_angle_CaCN</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bond_len_NCa</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bond_len_CaC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bond_len_CN</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># convert tertiary coords into Vectors</span>
    <span class="n">pV</span> <span class="o">=</span> <span class="p">[</span><span class="n">vec</span> <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">Vector</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                             <span class="nb">zip</span><span class="p">(</span><span class="n">tertiary</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tertiary</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tertiary</span><span class="p">[</span><span class="mi">2</span><span class="p">]))]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pV</span><span class="p">),</span> <span class="mi">3</span><span class="p">):</span>
        <span class="c1"># check for zero coords</span>
        <span class="n">norm_im1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">norm_i</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">norm_i1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">norm_i2</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">norm_i3</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">norm_i4</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm_im1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm_i</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm_i1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm_i2</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pV</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm_i3</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pV</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm_i4</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># compute bond lengths</span>
        <span class="k">if</span> <span class="n">norm_im1</span> <span class="ow">and</span> <span class="n">norm_i</span><span class="p">:</span>
            <span class="n">blen_CN</span> <span class="o">=</span> <span class="p">(</span><span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            <span class="n">bond_len_CN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blen_CN</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">norm_i</span> <span class="ow">and</span> <span class="n">norm_i1</span><span class="p">:</span>
            <span class="n">blen_NCa</span> <span class="o">=</span> <span class="p">(</span><span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            <span class="n">bond_len_NCa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blen_NCa</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">norm_i1</span> <span class="ow">and</span> <span class="n">norm_i2</span><span class="p">:</span>
            <span class="n">blen_CaC</span> <span class="o">=</span> <span class="p">(</span><span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            <span class="n">bond_len_CaC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blen_CaC</span><span class="p">)</span>

        <span class="c1"># compute bond angles</span>
        <span class="k">if</span> <span class="n">norm_im1</span> <span class="ow">and</span> <span class="n">norm_i</span> <span class="ow">and</span> <span class="n">norm_i1</span><span class="p">:</span>
            <span class="n">theta_CNCa</span> <span class="o">=</span> <span class="n">calc_angle</span><span class="p">(</span><span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># C-N-Ca</span>
            <span class="n">bond_angle_CNCa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta_CNCa</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">norm_i</span> <span class="ow">and</span> <span class="n">norm_i1</span> <span class="ow">and</span> <span class="n">norm_i2</span><span class="p">:</span>
            <span class="n">theta_NCaC</span> <span class="o">=</span> <span class="n">calc_angle</span><span class="p">(</span><span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># N-Ca-C</span>
            <span class="n">bond_angle_NCaC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta_NCaC</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">norm_i1</span> <span class="ow">and</span> <span class="n">norm_i2</span> <span class="ow">and</span> <span class="n">norm_i3</span><span class="p">:</span>
            <span class="n">theta_CaCN</span> <span class="o">=</span> <span class="n">calc_angle</span><span class="p">(</span><span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># Ca-C-N</span>
            <span class="n">bond_angle_CaCN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta_CaCN</span><span class="p">)</span>

        <span class="c1"># compute dihedral angles</span>
        <span class="k">if</span> <span class="n">norm_im1</span> <span class="ow">and</span> <span class="n">norm_i</span> <span class="ow">and</span> <span class="n">norm_i1</span> <span class="ow">and</span> <span class="n">norm_i2</span><span class="p">:</span>
            <span class="n">phi_i</span> <span class="o">=</span> <span class="n">calc_dihedral</span><span class="p">(</span>
                <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># N-Ca-C-N</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phi_i</span> <span class="o">=</span> <span class="n">INVALID_ANGLE</span>
        <span class="n">phi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phi_i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">norm_i</span> <span class="ow">and</span> <span class="n">norm_i1</span> <span class="ow">and</span> <span class="n">norm_i2</span> <span class="ow">and</span> <span class="n">norm_i3</span><span class="p">:</span>
            <span class="n">psi_i</span> <span class="o">=</span> <span class="n">calc_dihedral</span><span class="p">(</span>
                <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># C-N-Ca-C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi_i</span> <span class="o">=</span> <span class="n">INVALID_ANGLE</span>
        <span class="n">psi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">norm_i1</span> <span class="ow">and</span> <span class="n">norm_i2</span> <span class="ow">and</span> <span class="n">norm_i3</span> <span class="ow">and</span> <span class="n">norm_i4</span><span class="p">:</span>
            <span class="n">omega_i</span> <span class="o">=</span> <span class="n">calc_dihedral</span><span class="p">(</span>
                <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">pV</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># Ca-C-N-Ca</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">omega_i</span> <span class="o">=</span> <span class="n">INVALID_ANGLE</span>
        <span class="n">omega</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">omega_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">bond_angle_NCaC</span><span class="p">,</span> <span class="n">bond_angle_CaCN</span><span class="p">,</span>
            <span class="n">bond_angle_CNCa</span><span class="p">,</span> <span class="n">bond_len_CN</span><span class="p">,</span> <span class="n">bond_len_NCa</span><span class="p">,</span> <span class="n">bond_len_CaC</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_protein_from_file</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Parse ProteinNet file and add PHIPSI entries&#39;&#39;&#39;</span>
    <span class="n">CS</span> <span class="o">=</span> <span class="n">compute_stats</span><span class="p">()</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fname</span>
    <span class="n">out_fname</span> <span class="o">=</span> <span class="n">filename</span><span class="o">+</span><span class="s2">&quot;_ext&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pointer</span><span class="p">:</span>
            <span class="n">pcnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">id_next</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">next_line</span> <span class="o">=</span> <span class="n">file_pointer</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out_file</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">id_next</span><span class="p">:</span>
                    <span class="n">id_next</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="n">next_line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">next_line</span> <span class="o">==</span> <span class="s1">&#39;[ID]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="n">id_next</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">next_line</span> <span class="o">==</span> <span class="s1">&#39;[TERTIARY]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="n">tertiary</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># 3 dimension</span>
                    <span class="k">for</span> <span class="n">_axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">next_line</span> <span class="o">=</span> <span class="n">file_pointer</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">next_line</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out_file</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">tertiary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">next_line</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>

                    <span class="c1"># write the PHI_PSI angles</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[PHI_PSI]&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out_file</span><span class="p">)</span>

                    <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span>\
                        <span class="n">bond_angle_NCaC</span><span class="p">,</span> <span class="n">bond_angle_CaCN</span><span class="p">,</span> <span class="n">bond_angle_CNCa</span><span class="p">,</span>\
                        <span class="n">bond_len_CN</span><span class="p">,</span> <span class="n">bond_len_NCa</span><span class="p">,</span> <span class="n">bond_len_CaC</span> <span class="o">=</span> <span class="n">process_tertiary</span><span class="p">(</span>
                            <span class="n">tertiary</span><span class="p">)</span>

                    <span class="n">CS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bond_len_CN</span><span class="p">,</span> <span class="n">bond_len_NCa</span><span class="p">,</span> <span class="n">bond_len_CaC</span><span class="p">,</span>
                              <span class="n">bond_angle_CNCa</span><span class="p">,</span> <span class="n">bond_angle_NCaC</span><span class="p">,</span>
                              <span class="n">bond_angle_CaCN</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="n">pcnt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tertiary</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tertiary</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="mi">3</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>

                    <span class="c1"># print(gt, bl[gt])</span>
                    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
                        <span class="c1"># only plot valid phi,psi pairs (not equal to -1)</span>
                        <span class="n">phi_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
                        <span class="n">psi_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
                        <span class="n">phi_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">phi_a</span> <span class="o">!=</span> <span class="n">INVALID_ANGLE</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">psi_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">psi_a</span> <span class="o">!=</span> <span class="n">INVALID_ANGLE</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">val_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phi_idx</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">psi_idx</span><span class="p">))</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phi_a</span><span class="p">[</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">psi_a</span><span class="p">[</span><span class="n">val_idx</span><span class="p">],</span>
                                 <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

                    <span class="n">out_phi</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">phi</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">out_phi</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out_file</span><span class="p">)</span>
                    <span class="n">out_psi</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">psi</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">out_psi</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out_file</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">next_line</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="n">pcnt</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">next_line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="c1"># plt.show()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">fname</span><span class="o">+</span><span class="s1">&#39;_phipsi_plot.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                        <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">CS</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">read_protein_from_file</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</td></tr></table></p>
</div>
</div>
